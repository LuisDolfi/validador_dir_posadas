<!doctype html>
<html lang="es">
{% load static %}
<head>
    <meta charset="UTF-8">
    <title>VADI</title>

    <!-- 1ï¸âƒ£ CargÃ¡ primero tu hoja de estilos personalizada -->
    <link rel="stylesheet" href="{% static 'css/vadi.css' %}">

    <!-- 2ï¸âƒ£ Luego el CDN de Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-50 text-gray-900">
<body id="body">
<nav class="vadi-nav text-white shadow-lg">
  <div class="max-w-6xl mx-auto flex items-center justify-between px-4 py-3">

    <!-- LOGO / IDENTIDAD -->
    <div class="flex items-center space-x-3">
      <img src="https://upload.wikimedia.org/wikipedia/commons/3/35/Tux.svg"
           alt="VADI"
           class="h-9 w-9 rounded-full bg-white p-1 shadow-md">
      <a href="/" class="font-extrabold text-xl tracking-tight text-white drop-shadow-sm">
        VADI
      </a>
      <span class="text-xs font-light text-gray-200 italic">
        Validador de Direcciones Inteligente Â· Misiones ğŸ‡¦ğŸ‡·
      </span>
    </div>

    <!-- NAVEGACIÃ“N -->
    <div class="space-x-3 text-sm flex items-center">
      <a href="{% url 'validacion:usuario' %}" class="px-3 py-1 rounded hover:bg-green-900/40 transition">Validador</a>
      <a href="{% url 'validacion:historial' %}" class="px-3 py-1 rounded hover:bg-red-900/40 transition">Historial</a>

      {% if request.user.is_authenticated and request.user.is_staff %}
        <a href="/admin/"
           class="px-3 py-1 rounded bg-amber-400 text-black font-semibold hover:bg-amber-300 shadow">
           Herramientas
        </a>
        <a href="{% url 'dashboard' %}">Dashboard</a>
      {% else %}
        <a href="{% url 'login' %}?next=/admin/"
           class="px-3 py-1 rounded border border-white/50 hover:bg-white/20">
           Admin
        </a>
      {% endif %}

      {% if request.user.is_authenticated %}
        <span class="ml-2 text-xs text-gray-100">
          Hola, <strong>{{ request.user.username }}</strong>
        </span>
        <a href="{% url 'chat_ui' %}" class="ml-2 px-3 py-1 rounded hover:bg-white/20">Chat</a>
        <a href="{% url 'logout' %}" class="ml-2 px-3 py-1 rounded hover:bg-white/20">Salir</a>
      {% else %}
        <a href="{% url 'login' %}"
           class=class="ml-2 px-3 py-1 rounded hover:bg-white/20">Entrar</a>
        </a>
      {% endif %}
        <!-- BotÃ³n modo claro / oscuro -->
        <button id="themeToggle"
        aria-pressed="false"
        title="Cambiar a tema oscuro"
        onclick="toggleDarkMode()"
        class="ml-3 w-9 h-9 flex items-center justify-center rounded-full transition duration-300
                bg-transparent text-white hover:bg-white/10 focus:outline-none focus:ring-2 focus:ring-yellow-300">
        
        <!-- Luna (modo claro activo) -->
        <svg id="iconMoon" xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.6"
            d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z" />
        </svg>

        <!-- Sol (modo oscuro activo) -->
        <svg id="iconSun" xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <circle cx="12" cy="12" r="3" stroke-width="1.6" />
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.6"
            d="M12 2v2M12 20v2M4.93 4.93l1.41 1.41M17.66 17.66l1.41 1.41M2 12h2M20 12h2M4.93 19.07l1.41-1.41M17.66 6.34l1.41-1.41" />
        </svg>
        </button>
    </div>
  </div>
  </nav>
<!-- Franja bandera -->
    <div class="flag-stripe w-full">
        <div class="h-0.5 river"></div>
        <div class="h-0.5 bg-white"></div>
        <div class="h-0.5 river"></div>
    </div>
  <!-- Brillo dorado suave en el centro (sobre las rayas) -->
  <div class="absolute inset-1.5 flex justify-center pointer-events-none">
    <div class="w-1/3 h-1 px bg-gradient-to-r from-transparent via-yellow-500 to-transparent opacity-70"></div>
  </div>
</div>

  <main class="max-w-6xl mx-auto px-4 py-6">
    {% if messages %}
    <div class="p-3 rounded
           {% if m.level_tag == 'error' %} bg-red-100 text-red-800
           {% elif m.level_tag == 'warning' %} bg-yellow-100 text-yellow-800
           {% else %} bg-green-100 text-green-800
           {% endif %}">
        {{ m }}
      </div>
    {% endif %}
   {% block content %}{% endblock %}
  </main>

<footer class="text-center text-xs text-gray-500 py-6">
  Hecho en Misiones ğŸ‡¦ğŸ‡· Â· VADI 2025 Â· <span class="font-semibold text-emerald-700">La Empresa</span>
</footer>
<script>
  // ğŸ” Actualiza el Ã­cono y accesibilidad
  function updateIcon(isDark) {
    document.getElementById('iconMoon').classList.toggle('hidden', isDark);
    document.getElementById('iconSun').classList.toggle('hidden', !isDark);
    const btn = document.getElementById('themeToggle');
    btn.setAttribute('aria-pressed', isDark ? 'true' : 'false');
    btn.title = isDark ? 'Cambiar a tema claro' : 'Cambiar a tema oscuro';
  }

  // ğŸŒ™ Inicializa segÃºn preferencia guardada o del sistema
  (function initTheme() {
    const saved = localStorage.getItem('theme');
    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    const useDark = saved ? saved === 'dark' : prefersDark;
    const body = document.getElementById('body');
    body.classList.toggle('dark-mode', useDark);
    updateIcon(useDark);
  })();

  // ğŸŒ— Cambia de modo con animaciÃ³n y guarda preferencia
  function toggleDarkMode() {
    const body = document.getElementById('body');
    const isDark = body.classList.toggle('dark-mode');
    localStorage.setItem('theme', isDark ? 'dark' : 'light');
    updateIcon(isDark);

    // AnimaciÃ³n de â€œclick suaveâ€
    const btn = document.getElementById('themeToggle');
    btn.animate([
      { transform: 'scale(1)', opacity: 1 },
      { transform: 'scale(1.25)', opacity: 0.8 },
      { transform: 'scale(1)', opacity: 1 }
    ], { duration: 250, easing: 'ease-in-out' });
  }
</script>
<script>
  // Conjunto de weathercodes con lluvia/llovizna segÃºn Open-Meteo
  const RAINY_CODES = new Set([
    51,53,55,56,57,61,63,65,66,67,80,81,82,95,96,99 // drizzle/rain/showers/thunder + precip
  ]);

  async function resolveCoords() {
    // 1) Geoloc del navegador (si el usuario acepta)
    try {
      const pos = await new Promise((res, rej) =>
        navigator.geolocation ?
          navigator.geolocation.getCurrentPosition(res, rej, {timeout:3000}) :
          rej(new Error('no geo'))
      );
      return { lat: pos.coords.latitude, lon: pos.coords.longitude };
    } catch {
      // 2) Fallback: Posadas, Misiones
      return { lat: -27.362, lon: -55.900 };
    }
  }

  function cacheGet(key) {
    try { return JSON.parse(localStorage.getItem(key)); } catch { return null; }
  }
  function cacheSet(key, val) {
    try { localStorage.setItem(key, JSON.stringify(val)); } catch {}
  }

  async function checkRainAuto() {
    // Override manual por query (?rain=1 / ?rain=0)
    const qp = new URLSearchParams(location.search);
    if (qp.has('rain')) {
      const forced = qp.get('rain') === '1';
      toggleRain(forced); return;
    }

    // Usa cachÃ© diario
    const today = new Date().toISOString().slice(0,10);
    const cached = cacheGet('vadi_rain_cache');
    if (cached && cached.date === today) { toggleRain(!!cached.isRain); return; }

    const {lat, lon} = await resolveCoords();
    const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}` +
                `&current=precipitation,weather_code&hourly=precipitation_probability,weather_code&timezone=auto`;
    let isRain = false;
    try {
      const r = await fetch(url, {cache:'no-store'});
      const data = await r.json();
      const cw = data.current || data.current_weather || {};
      const code = cw.weather_code ?? cw.weathercode ?? null;
      const precip = cw.precipitation ?? 0;

      // criterio: cÃ³digo lluvioso, o precip > 0, o prob. > 50% en la prÃ³xima hora
      const nextProb = (data.hourly?.precipitation_probability?.[0] ?? 0);
      isRain = (code != null && RAINY_CODES.has(Number(code))) || (Number(precip) > 0) || (Number(nextProb) >= 50);
    } catch(e) {
      // si falla la red, no activamos lluvia
      isRain = false;
    }
    cacheSet('vadi_rain_cache', {date: today, isRain});
    toggleRain(isRain);
  }

  function toggleRain(on){
    const nav = document.querySelector('.vadi-nav');
    if (!nav) return;
    nav.classList.toggle('rainy', !!on);
  }

  // Dispara al cargar
  checkRainAuto();
</script>
</body>
</html>
